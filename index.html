<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Reset Password</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{
        --brand:#63C1E3;
        --bg-top:#63C1E3;
        --bg-bot:#1E2931;
        --glass-bg: rgba(255,255,255,0.08);
        --glass-stroke: rgba(255,255,255,0.16);
        --text:#fff;
        --text-muted: rgba(255,255,255,0.75);
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        color: var(--text);
        background: linear-gradient(180deg, var(--bg-top) 0%, var(--bg-bot) 100%);
        display:flex; align-items:center; justify-content:center;
      }
      .container{
        width:100%; max-width:420px; padding:16px;
      }
      .glass{
        background: var(--glass-bg);
        border: 1px solid var(--glass-stroke);
        border-radius: 16px;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.18);
        padding: 16px;
      }
      .header{
        display:flex; align-items:center; justify-content:space-between;
        margin-bottom:12px;
      }
      .title{font-size:20px; font-weight:800; letter-spacing:.2px}
      .chip{
        padding:6px 10px; border-radius:12px; border:1px solid var(--glass-stroke);
        background: rgba(255,255,255,0.10); color: var(--text);
        font-size:12px; font-weight:700;
      }
      .muted{color: var(--text-muted); font-size: 13px}
      .field{display:flex; flex-direction:column; gap:6px; margin-top:12px}
      label{font-size:12px; color:var(--text-muted)}
      input[type="password"]{
        width:100%;
        padding:12px 12px;
        border-radius:14px;
        border:1px solid var(--glass-stroke);
        background: rgba(255,255,255,0.08);
        color: var(--text);
        outline:none;
      }
      .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:14px}
      .btn{
        appearance:none; border:none; cursor:pointer;
        padding:10px 16px; border-radius:999px; font-weight:700;
      }
      .btn.secondary{background: rgba(255,255,255,0.12); color: var(--text)}
      .btn.primary{background: var(--brand); color:#fff}
      .status{margin-top:10px; font-size:13px}
      .hidden{display:none}
    </style>

    <script type="module">
      import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

      // Replace with your project values
      const SUPABASE_URL = 'https://eotuawlegqyqthsuxdmt.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvdHVhd2xlZ3F5cXRoc3V4ZG10Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1Njk5OTUsImV4cCI6MjA3NTE0NTk5NX0.KgyUcy4ubmQHiCpfeLRWRC-J2xL3-9BG7EIUJSb1Tds';

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Parse tokens from URL fragment (#access_token=...&refresh_token=...&type=recovery)
      const params = new URLSearchParams(location.hash.slice(1));
      const type = params.get('type');
      const access_token = params.get('access_token');

      // If recovery session present, set the session so updateUser works
      async function ensureSession() {
        if (type === 'recovery' && access_token) {
          const { data, error } = await supabase.auth.setSession({
            access_token,
            refresh_token: params.get('refresh_token'),
          });
          if (error) {
            document.getElementById('status').textContent = 'Error setting session: ' + error.message;
          } else {
            document.getElementById('loadingRow').style.display = 'none';
            document.getElementById('form').classList.remove('hidden');
          }
        } else {
          document.getElementById('status').textContent = 'Invalid or expired reset link.';
        }
      }

      async function handleSubmit(e) {
        e.preventDefault();
        const newPass = document.getElementById('password').value.trim();
        const { data, error } = await supabase.auth.updateUser({ password: newPass });
        const out = document.getElementById('status');
        if (error) {
          out.textContent = 'Failed to update password: ' + error.message;
        } else {
          out.textContent = 'Password updated successfully. You can close this page.';
          document.getElementById('form').classList.add('hidden');
        }
      }

      window.addEventListener('DOMContentLoaded', () => {
        document.getElementById('form').addEventListener('submit', handleSubmit);
        ensureSession();
      });
    </script>
  </head>
  <body>
    <div class="container">
      <div class="glass">
        <div class="header">
          <div style="display:flex; align-items:center; gap:10px">
            <img src="./Logo.svg" alt="Gabay" style="width:28px;height:28px; display:block" />
            <div class="title">Reset Password</div>
          </div>
          <div class="chip">Secure</div>
        </div>
        <p class="muted">Enter your new password below. This page will securely update your account.</p>

        <div id="loadingRow" class="status">Loading…</div>

        <form id="form" class="hidden">
          <div class="field">
            <label for="password">New Password</label>
            <input id="password" type="password" minlength="6" placeholder="••••••" required />
          </div>
          <div class="actions">
            <button type="submit" class="btn primary">Update Password</button>
          </div>
        </form>

        <div id="status" class="status"></div>
      </div>
    </div>
  </body>
</html>